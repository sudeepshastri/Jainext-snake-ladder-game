<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jainext Snake & Ladder Game</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;700&family=Roboto:wght@400;600;700&display=swap');

        :root {
            --snake-color: #2ecc71;
            --ladder-color: #27ae60;
            --button-disabled-bg: #95a5a6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Roboto', 'Noto Sans Devanagari', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }
        
        .fullscreen-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            position: relative;
        }
        
        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 0px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            z-index: 100;
        }
        
        .game-title { display: flex; align-items: center; gap: 15px; }
        .logo-container { width: 160px; height: 160px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2em; cursor: default; transition: all 0.3s ease; overflow: hidden; }
        .logo-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: none; }
        .title-text { color: white; font-size: 2.2em; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        
        .controls { display: flex; gap: 10px; align-items: center; }
        .volume-control { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 25px; }
        .volume-slider { width: 80px; }
        
        .header-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 12px 20px; border-radius: 25px; cursor: pointer; font-size: 1em; transition: all 0.3s ease; }
        .header-btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
        
        .main-container { flex: 1; display: flex; padding: 20px; gap: 20px; overflow: hidden; }
        .game-board-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        .board-logo-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 120px;
            height: 120px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 10px;
            backdrop-filter: blur(5px);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .board-logo-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }

        .game-board {
            width: min(70vh, 80vw);
            height: min(70vh, 80vw);
            background: linear-gradient(45deg, #f0f8ff, #e6f3ff);
            border: 8px solid #2c3e50;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            gap: 2px;
            padding: 10px;
            position: relative;
        }
        
        .cell { background: linear-gradient(135deg, #ffffff, #f8f9fa); border: 2px solid #34495e; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: clamp(0.8em, 2vw, 1.2em); color: #2c3e50; position: relative; transition: all 0.3s ease; }
        .cell .emoji { font-size: 1.8em; position: absolute; z-index: 2; }
        .cell-number { position: absolute; top: 2px; left: 4px; font-size: 0.7em; color: #7f8c8d; }
        
        .snake-start { background: #d9f7e6; }
        .ladder-start { background: #d4edda; }

        .player { position: absolute; width: 25px; height: 25px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.4); font-size: 0.8em; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); transition: all 0.5s ease; z-index: 10; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        .player-1 { background: #e74c3c; } .player-2 { background: #3498db; } .player-3 { background: #2ecc71; } .player-4 { background: #f1c40f; } .player-5 { background: #9b59b6; } .player-6 { background: #1abc9c; }
        
        .side-panel { width: 350px; background: rgba(255,255,255,0.95); border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow-y: auto; }
        
        .setup-section, .game-section { display: none; }
        .setup-section.active, .game-section.active { display: block; }
        .section-title { font-size: 1.5em; font-weight: 700; color: #2c3e50; text-align: center; margin-bottom: 15px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #34495e; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border: 2px solid #bdc3c7; border-radius: 8px; font-size: 1em; transition: all 0.3s ease; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #3498db; box-shadow: 0 0 10px rgba(52, 152, 219, 0.3); }
        .file-upload { position: relative; display: inline-block; width: 100%; }
        .file-upload input[type=file] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .file-upload-label { display: block; padding: 12px; background: #ecf0f1; border: 2px dashed #bdc3c7; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .file-upload-label:hover { background: #d5dbdb; border-color: #95a5a6; }
        
        .sound-upload-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .sound-upload-group label { font-weight: normal; flex-basis: 40%; }
        .sound-upload-label { padding: 5px 10px; background: #ecf0f1; border: 1px solid #bdc3c7; border-radius: 5px; cursor: pointer; text-align: center; flex-basis: 55%; font-size: 0.9em; }
        .sound-upload-label:hover { background: #e0e0e0; }

        .btn { padding: 12px 25px; border: none; border-radius: 25px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; text-decoration: none; display: inline-block; text-align: center;}
        .btn:disabled { background: var(--button-disabled-bg); box-shadow: none !important; transform: none !important; cursor: not-allowed; opacity: 0.6; }
        
        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .btn-primary:not(:disabled):hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4); }
        .btn-secondary { background: linear-gradient(135deg, #95a5a6, #7f8c8d); color: white; }
        .btn-secondary:not(:disabled):hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(127, 140, 141, 0.4); }
        .btn-success { background: linear-gradient(135deg, var(--ladder-color), #229954); color: white; }
        .btn-success:not(:disabled):hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4); }
        
        .dice-container { text-align: center; margin-bottom: 20px; }
        .dice { width: 80px; height: 80px; background: white; border: 3px solid #2c3e50; border-radius: 15px; display: inline-flex; align-items: center; justify-content: center; font-size: 2.5em; font-weight: bold; color: #2c3e50; cursor: pointer; transition: all 0.3s ease; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .dice:hover { transform: scale(1.1) rotate(5deg); }
        
        .current-player { text-align: center; padding: 15px; background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border-radius: 15px; font-size: 1.2em; font-weight: 600; margin-bottom: 15px; transition: background 0.5s ease; }
        
        .players-list { background: #ecf0f1; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #bdc3c7; }
        .player-item:last-child { border-bottom: none; }
        
        .question-popup, .guide-popup, .guidelines-prompt-popup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s; pointer-events: none;
        }
        .question-popup.active, .guide-popup.active, .guidelines-prompt-popup.active {
            opacity: 1; visibility: visible; transition: opacity 0.3s ease; pointer-events: all;
        }
        
        .question-card, .guide-content, .guidelines-prompt-content { background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); transform: scale(0.8); transition: transform 0.3s ease; }
        .question-popup.active .question-card, .guide-popup.active .guide-content, .guidelines-prompt-popup.active .guidelines-prompt-content { transform: scale(1); }
        
        .question-card { padding: 60px; max-width: 850px; width: 90vw; }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .timer { background: #e74c3c; color: white; padding: 10px 15px; border-radius: 25px; font-weight: bold; font-size: 1.2em; }
        .timer.warning { background: #f39c12; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.5; } }
        .question-text { font-size: 2.4em; font-weight: 800; margin-bottom: 30px; text-align: center; color: #2c3e50; line-height: 1.4; }
        .options-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .option { padding: 25px; border: 2px solid #bdc3c7; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; text-align: center; font-weight: 800; font-size: 2.1em; }
        .option:hover { border-color: #3498db; background: #ecf0f1; transform: translateY(-2px); }
        .option.selected { background: #3498db; color: white; border-color: #2980b9; }
        .option.correct { background: var(--ladder-color); color: white; border-color: #229954; }
        .option.wrong { background: #e74c3c; color: white; border-color: #c0392b; }
        
        .winners-section { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; padding: 20px; border-radius: 15px; text-align: center; }
        .winner-item { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.3); font-size: 1.1em; }
        .winner-item:last-child { border-bottom: none; }
        
        .svg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .snake-outline, .snake-body { stroke-linecap: round; fill: none; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3)); }
        .snake-outline { stroke: #2c3e50; stroke-width: 10px; }
        .snake-body { stroke: var(--snake-color); stroke-width: 6px; }
        .ladder-side { stroke: #8B4513; stroke-width: 8px; stroke-linecap: round; opacity: 0.9; }
        .ladder-rung { stroke: #AF601A; stroke-width: 6px; stroke-linecap: round; opacity: 0.9; }
        
        .developer-credit { text-align: center; font-size: 0.8em; color: #7f8c8d; }
        .side-panel-footer { margin-top: auto; padding-top: 15px; }
        .history-controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
        .history-controls .btn { padding: 10px 15px; flex-grow: 1; }

        .dice-popup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; z-index: 2000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s; pointer-events: none;
        }
        .dice-popup.active { opacity: 1; visibility: visible; transition: opacity 0.3s ease; pointer-events: all; }
        .dice-popup-content {
            width: 550px; height: 550px; background: white; border: 5px solid #2c3e50; border-radius: 50px;
            display: flex; align-items: center; justify-content: center; font-size: 25em; font-weight: bold; color: #2c3e50;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: scale(0.8); transition: transform 0.3s ease;
        }
        .dice-popup.active .dice-popup-content { transform: scale(1); }
        .dice-popup-content.rolling { animation: roll 0.5s infinite linear; }
        @keyframes roll { from { transform: rotate(0deg) scale(1.1); } to { transform: rotate(360deg) scale(1.1); } }
        
        .guide-popup { z-index: 999; }
        .guide-content {
            position: relative; padding: 30px 40px; width: 90vw; max-width: 800px;
            max-height: 85vh; overflow-y: auto; color: #333; line-height: 1.6;
        }
        .guide-close-btn {
            position: absolute; top: 15px; right: 20px; font-size: 2.5em; color: #aaa;
            cursor: pointer; line-height: 1; transition: color 0.2s ease;
        }
        .guide-close-btn:hover { color: #333; }
        .guide-content h2 { font-size: 1.8em; color: #2c3e50; text-align: center; margin-bottom: 20px; }
        .guide-content h3 { font-size: 1.3em; color: #2980b9; margin-top: 25px; margin-bottom: 10px; border-bottom: 2px solid #ecf0f1; padding-bottom: 5px; }
        .guide-content p, .guide-content li { font-size: 1em; }
        .guide-content ul { padding-left: 20px; }
        .guide-content strong { color: #2c3e50; }
        .guide-content table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .guide-content th, .guide-content td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .guide-content th { background-color: #f2f2f2; font-weight: 600; }
        .guide-content code { background: #ecf0f1; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        
        .guidelines-prompt-content {
            padding: 40px;
            max-width: 500px;
            text-align: center;
        }
        .guidelines-prompt-content h2 {
            font-size: 1.6em;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        .guidelines-prompt-content p {
            margin-bottom: 30px;
            color: #34495e;
            font-size: 1.1em;
        }
        .guidelines-prompt-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        @media (max-width: 1200px) {
            .board-logo-container { display: none; }
        }
        @media (max-width: 768px) {
            .main-container { flex-direction: column; padding: 10px; }
            .side-panel { width: 100%; height: auto; max-height: 45vh; order: 1; }
            .game-board-container { order: 2; }
            .header { order: 0; padding: 10px 15px; flex-wrap: wrap; }
            .title-text { font-size: 1.5em; }
            .controls { gap: 5px; flex-basis: 100%; justify-content: center; padding-top: 5px; }
            .header-btn { padding: 8px 12px; font-size: 0.9em; }
        }
    </style>
</head>
<body>
    <div class="fullscreen-container" id="gameContainer">
        <div class="header">
            <div class="game-title">
                <div class="logo-container">
                    <span>🎲</span>
                    <img class="logo-img" id="gameLogoImg" alt="Game Logo">
                </div>
                <div class="title-text" id="gameTitle">Jainext Snake & Ladder Game</div>
            </div>
            <div class="controls">
                <div class="volume-control">
                    <span id="volumeIcon">🔊</span>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50">
                </div>
                <button class="header-btn" onclick="toggleGuide()">❓ How to Play</button>
                <button class="header-btn" id="fullscreenBtn" onclick="toggleFullscreen()">⛶ Fullscreen</button>
            </div>
        </div>
        
        <div class="main-container">
            <div class="game-board-container">
                 <div class="board-logo-container">
                    <img id="boardLogoImg" class="board-logo-img" alt="Board Logo">
                </div>
                <div class="game-board" id="gameBoard">
                    <svg id="svgLayer" class="svg-layer"></svg>
                </div>
            </div>
            
            <div class="side-panel">
                <div class="setup-section active" id="setupSection">
                    <h2 class="section-title">🎮 Game Setup</h2>
                    <div class="input-group"><label for="gameNameInput">🏷️ Game Name:</label><input type="text" id="gameNameInput" value="Jainext Snake & Ladder Game" placeholder="Enter game name"></div>
                    <div class="input-group"><label for="numPlayers">👥 Number of Players (2-6):</label><select id="numPlayers"><option value="2">2 Players</option><option value="3">3 Players</option><option value="4" selected>4 Players</option><option value="5">5 Players</option><option value="6">6 Players</option></select></div>
                    <div id="playerNames"></div>
                    <div class="input-group"><label for="timerDuration">⏱️ Question Timer (seconds):</label><select id="timerDuration"><option value="5">5s</option><option value="10">10s</option><option value="15" selected>15s</option><option value="20">20s</option><option value="25">25s</option><option value="30">30s</option></select></div>
                    <div class="input-group"><label>🖼️ Upload Game Logo:</label><div class="file-upload"><input type="file" id="logoUpload" accept="image/*" onchange="handleLogoUpload(event)"><label for="logoUpload" class="file-upload-label" id="logoLabel">📁 Click to upload Logo</label></div></div>
                    <div class="input-group"><label>📄 Upload Questions CSV:</label><div class="file-upload"><input type="file" id="csvUpload" accept=".csv" onchange="handleCsvUpload(event)"><label for="csvUpload" class="file-upload-label" id="csvLabel">📁 Click to upload CSV<br><small>Format: q,o1,o2,o3,o4,ans,lvl</small></label></div></div>
                    
                    <div class="input-group">
                        <h3 style="font-size:1.1em; color:#2c3e50; margin-bottom:10px; text-align:center;">🔊 Upload Custom Sounds (Optional)</h3>
                         <div class="sound-upload-group">
                            <label>Timer Tick:</label>
                            <label for="timerTickSoundUpload" class="sound-upload-label" id="timerTickSoundUploadLabel">Select file...</label>
                            <input type="file" id="timerTickSoundUpload" accept="audio/*" onchange="handleSoundUpload(event, 'timerTickSound')" style="display:none;">
                        </div>
                        <div class="sound-upload-group">
                            <label>Dice Roll:</label>
                            <label for="diceSoundUpload" class="sound-upload-label" id="diceSoundUploadLabel">Select file...</label>
                            <input type="file" id="diceSoundUpload" accept="audio/*" onchange="handleSoundUpload(event, 'diceRollSound')" style="display:none;">
                        </div>
                        <div class="sound-upload-group">
                            <label>Correct Answer:</label>
                            <label for="correctSoundUpload" class="sound-upload-label" id="correctSoundUploadLabel">Select file...</label>
                            <input type="file" id="correctSoundUpload" accept="audio/*" onchange="handleSoundUpload(event, 'correctSound')" style="display:none;">
                        </div>
                        <div class="sound-upload-group">
                            <label>Wrong Answer:</label>
                            <label for="wrongSoundUpload" class="sound-upload-label" id="wrongSoundUploadLabel">Select file...</label>
                            <input type="file" id="wrongSoundUpload" accept="audio/*" onchange="handleSoundUpload(event, 'wrongSound')" style="display:none;">
                        </div>
                        <div class="sound-upload-group">
                            <label>Player Move:</label>
                            <label for="moveSoundUpload" class="sound-upload-label" id="moveSoundUploadLabel">Select file...</label>
                            <input type="file" id="moveSoundUpload" accept="audio/*" onchange="handleSoundUpload(event, 'moveSound')" style="display:none;">
                        </div>
                        <div class="sound-upload-group">
                            <label>Snake:</label>
                            <label for="snakeSoundUpload" class="sound-upload-label" id="snakeSoundUploadLabel">Select file...</label>
                            <input type="file" id="snakeSoundUpload" accept="audio/*" onchange="handleSoundUpload(event, 'snakeSound')" style="display:none;">
                        </div>
                        <div class="sound-upload-group">
                            <label>Ladder:</label>
                            <label for="ladderSoundUpload" class="sound-upload-label" id="ladderSoundUploadLabel">Select file...</label>
                            <input type="file" id="ladderSoundUpload" accept="audio/*" onchange="handleSoundUpload(event, 'ladderSound')" style="display:none;">
                        </div>
                        <div class="sound-upload-group">
                            <label>Win Game:</label>
                            <label for="winSoundUpload" class="sound-upload-label" id="winSoundUploadLabel">Select file...</label>
                            <input type="file" id="winSoundUpload" accept="audio/*" onchange="handleSoundUpload(event, 'winSound')" style="display:none;">
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="startGame()" style="width: 100%;">🚀 Start Game</button>
                </div>
                
                <div class="game-section" id="gameSection">
                    <h2 class="section-title">🎯 Game Status</h2>
                    <div class="current-player" id="currentPlayerDisplay">Player 1's Turn</div>
                    <div class="dice-container">
                        <div class="dice" id="dice" onclick="rollDice()">🎲</div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button class="btn btn-success" onclick="rollDice()" id="rollButton">🎲 Roll Dice</button>
                            <button class="btn btn-secondary" onclick="skipTurn()" id="skipTurnButton">Skip Turn</button>
                        </div>
                    </div>
                    <div class="players-list" id="playersList"></div>
                    <div class="winners-section" id="winnersSection" style="display: none;"><h3>🏆 Winners</h3><div id="winnersList"></div></div>
                </div>
                
                <div class="side-panel-footer">
                    <div class="history-controls">
                        <button class="btn btn-secondary" id="undoButton" onclick="undoStep()">↶ Undo</button>
                        <button class="btn btn-secondary" id="redoButton" onclick="redoStep()">Redo ↷</button>
                    </div>
                    <button class="btn btn-secondary" id="endGameButton" onclick="forceEndGame()" style="width:100%; margin-bottom: 10px;">Declare Winners</button>
                    <button class="btn btn-primary" id="newGameButton" onclick="resetGame()" style="width:100%; margin-bottom: 10px;">🔄 New Game</button>
                    <p class="developer-credit">Developed by Sudeep Jain Shastri</p>
                </div>
            </div>
        </div>

        <div class="question-popup" id="questionPopup">
            <div class="question-card">
                <div class="question-header"><h3>❓ Question</h3><div class="timer" id="questionTimer">15</div></div>
                <div class="question-text" id="questionText">Loading question...</div>
                <div class="options-container" id="optionsContainer"></div>
                <button class="btn btn-primary" onclick="submitAnswer()" id="submitButton" style="width: 100%;">✅ Submit Answer</button>
            </div>
        </div>

        <div class="dice-popup" id="dicePopup">
            <div class="dice-popup-content" id="dicePopupContent">🎲</div>
        </div>
        
        <div class="guide-popup" id="guidePopup">
            <div class="guide-content">
                <span class="guide-close-btn" onclick="toggleGuide()">×</span>
                <h2>Jainext Snake & Ladder - How to Play</h2>
                <h3>⚙️ 2. How to Play (Game Setup Panel)</h3>
                <p>When you open the game, you'll see the setup panel on the right. Configure your game here before starting.</p>
                <ul><li><strong>🏷️ Game Name:</strong> Enter a title for your game session...</li><li><strong>👥 Number of Players:</strong> Select how many people (from 2 to 6) are playing...</li></ul>
                <h3>🎮 3. Gameplay Controls & Flow</h3>
                <p>After starting the game, the side panel changes to the game status view.</p>
                <ul><li><strong>Current Player Display:</strong> A colored banner at the top shows whose turn it is...</li></ul>
                <h3>✨ 4. Special Host Features</h3>
                <ul><li><strong>↶ Undo / Redo ↷:</strong> Made a mistake? You can go back one step...</li></ul>
                <h3>⌨️ 5. Shortcut Keys for the Host</h3>
                <p>Use these keyboard shortcuts to manage the game more quickly.</p>
                <table>
                    <thead><tr><th>Key(s)</th><th>Action</th><th>Context</th></tr></thead>
                    <tbody>
                        <tr><td><code>PageDown</code></td><td><strong>Roll the Dice</strong></td><td>During gameplay</td></tr>
                        <tr><td><code>Alt</code> + <code>D</code></td><td><strong>Roll the Dice</strong></td><td>During gameplay</td></tr>
                        <tr><td><code>Alt</code> + <code>S</code></td><td><strong>Submit Answer</strong></td><td>Question pop-up is visible</td></tr>
                        <tr><td><code>Alt</code> + <code>1</code>/<code>2</code>/<code>3</code>/<code>4</code></td><td>Select & Submit Option</td><td>Question pop-up is visible</td></tr>
                        <tr><td><code>Ctrl</code> + <code>Z</code></td><td><strong>Undo</strong> Last Action</td><td>Any point during the game</td></tr>
                        <tr><td><code>Ctrl</code> + <code>Y</code></td><td><strong>Redo</strong> Last Action</td><td>Any point during the game</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="guidelines-prompt-popup" id="guidelinesPromptPopup">
            <div class="guidelines-prompt-content">
                <h2>Ready to Play?</h2>
                <p>You can review the game guidelines before starting. They will open in a new tab.</p>
                <div class="guidelines-prompt-buttons">
                    <a href="assets/Game Guidelines.pdf" target="_blank" class="btn btn-secondary">📄 View Game Guidelines</a>
                    <button class="btn btn-primary" onclick="proceedToGame()">▶️ Continue to Game</button>
                </div>
            </div>
        </div>

        <div class="sound-effects" style="display: none;">
            <audio id="timerTickSound" src=""></audio>
            <audio id="diceRollSound" src=""></audio>
            <audio id="correctSound" src=""></audio>
            <audio id="wrongSound" src=""></audio>
            <audio id="moveSound" src=""></audio>
            <audio id="snakeSound" src=""></audio>
            <audio id="ladderSound" src=""></audio>
            <audio id="winSound" src=""></audio>
        </div>
    </div>
<script>
        // Game Configuration and State variables
        const BOARD_SIZE = 100;
        const SNAKES = { 16: 6, 47: 26, 49: 11, 56: 53, 62: 19, 64: 60, 87: 24, 93: 73, 95: 75, 99: 78 };
        const LADDERS = { 1: 38, 4: 14, 9: 31, 21: 42, 28: 84, 36: 44, 51: 67, 71: 91, 80: 96 };
        
        const DEFAULT_ASSETS = {
            logo: 'assets/logo.png',
            questions: 'assets/questions.csv',
            sounds: {
                timerTickSound: 'assets/timer_tick.mp3',
                diceRollSound: 'assets/dice_roll.mp3',
                correctSound: 'assets/correct.mp3',
                wrongSound: 'assets/wrong.mp3',
                moveSound: 'assets/move.mp3',
                snakeSound: 'assets/snake.mp3',
                ladderSound: 'assets/ladder.mp3',
                winSound: 'assets/win.mp3'
            }
        };

        let gameState = {};
        let history = [];
        let historyIndex = -1;
        const MAX_HISTORY = 10;
        const MAX_STUCK_TURNS = 4;

        const DEFAULT_QUESTIONS = [
            { question: "What is the capital of France?", options: ["Berlin", "Madrid", "Paris", "Rome"], answer: 2, level: "easy" },
            { question: "What is 8 x 7?", options: ["54", "56", "64", "68"], answer: 1, level: "medium" },
        ];

        function initializeGameState() {
             gameState = {
                players: [], currentPlayerIndex: 0, gameStarted: false, masterQuestions: [], availableQuestions: [], usedQuestions: [],
                csvUploaded: false, logoUploaded: false, soundsUploaded: {}, timerDuration: 15, winners: [], soundEnabled: true,
                volume: 0.5, currentQuestion: null, selectedOption: -1, questionTimer: null, isSubmitting: false
            };
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeGameState();
            gameState.masterQuestions = [...DEFAULT_QUESTIONS];
            setupNumberOfPlayers();
            createBoard();
            setupVolumeControl();
            setupGameNameInput();
            updateHistoryButtons();
            
            document.addEventListener('keydown', handleKeyboardShortcuts);

            window.addEventListener('resize', () => {
                if (gameState.gameStarted) {
                    drawSnakesAndLadders();
                }
            });
        });

        function toggleGuide() {
            document.getElementById('guidePopup').classList.toggle('active');
        }

        async function startGame() {
            await loadDefaultAssets();
            
            const masterQuestions = gameState.masterQuestions;
            const currentSetup = {
                csvUploaded: gameState.csvUploaded,
                logoUploaded: gameState.logoUploaded,
                soundsUploaded: gameState.soundsUploaded
            };

            initializeGameState();
            
            gameState.masterQuestions = masterQuestions;
            gameState.availableQuestions = [...masterQuestions];
            gameState.csvUploaded = currentSetup.csvUploaded;
            gameState.logoUploaded = currentSetup.logoUploaded;
            gameState.soundsUploaded = currentSetup.soundsUploaded;

            const numPlayers = parseInt(document.getElementById('numPlayers').value);
            gameState.players = Array.from({ length: numPlayers }, (_, i) => ({
                name: document.getElementById(`player${i + 1}Name`).value || `Player ${i + 1}`,
                position: 0,
                stuckCounter: 0, 
                color: `player-${i + 1}`
            }));
            gameState.timerDuration = parseInt(document.getElementById('timerDuration').value);
            
            document.getElementById('guidelinesPromptPopup').classList.add('active');
        }
        
        function proceedToGame() {
            document.getElementById('guidelinesPromptPopup').classList.remove('active');
            
            gameState.gameStarted = true;
            document.getElementById('setupSection').classList.remove('active');
            document.getElementById('gameSection').classList.add('active');
            
            history = [];
            historyIndex = -1;
            saveStateToHistory(); 

            updateAllUI();
        }

        // [FIX 1 of 3] Add .load() when setting default sound sources
        async function loadDefaultAssets() {
            // ... (logo and csv loading is unchanged)
            if (!gameState.logoUploaded) { /* ... */ }
            if (!gameState.csvUploaded) { /* ... */ }

            for (const soundId in DEFAULT_ASSETS.sounds) {
                if (!gameState.soundsUploaded[soundId]) {
                    const audioEl = document.getElementById(soundId);
                    if (audioEl) {
                        audioEl.src = DEFAULT_ASSETS.sounds[soundId];
                        audioEl.load(); // Explicitly tell the browser to load the new source
                    }
                    const labelEl = document.getElementById(soundId + 'Label');
                    if (labelEl) {
                        labelEl.textContent = '✅ Default';
                        labelEl.style.backgroundColor = '#e9ecef';
                    }
                }
            }
        }

        // [FIX 2 of 3] Add .load() when handling custom sound uploads
        function handleSoundUpload(event, audioId) {
            const file = event.target.files[0];
            const audioEl = document.getElementById(audioId);
            const labelEl = document.getElementById(event.target.id + 'Label');
            if (file && audioEl && labelEl) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    audioEl.src = e.target.result;
                    audioEl.load(); // Explicitly load the new file
                    gameState.soundsUploaded[audioId] = true;
                    labelEl.textContent = '✅ Loaded';
                    labelEl.style.backgroundColor = '#d4edda';
                }
                reader.readAsDataURL(file);
            }
        }

        // [FIX 3 of 3] Improve playSound to log errors for easier debugging
        function playSound(soundId) {
            if (gameState.soundEnabled) {
                const audio = document.getElementById(soundId);
                if (audio && audio.src) {
                    audio.volume = gameState.volume;
                    audio.currentTime = 0;
                    const playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            // This catches errors like the file not being found (404)
                            // or the browser blocking autoplay. It's useful for debugging.
                            console.error(`Error playing sound '${soundId}':`, error);
                        });
                    }
                }
            }
        }
        
        // --- The rest of the JavaScript functions are unchanged ---
        
        function handleKeyboardShortcuts(event) {
            const activeElement = document.activeElement;
            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT')) { return; }
            if (event.key.toLowerCase() === 'pagedown') {
                event.preventDefault();
                document.getElementById('rollButton').click();
                return;
            }
            if (event.ctrlKey) {
                if (event.key.toLowerCase() === 'z') { event.preventDefault(); document.getElementById('undoButton').click(); }
                if (event.key.toLowerCase() === 'y') { event.preventDefault(); document.getElementById('redoButton').click(); }
            } else if (event.altKey) {
                event.preventDefault();
                switch (event.key.toLowerCase()) {
                    case 'd': document.getElementById('rollButton').click(); break;
                    case 's': if (document.getElementById('questionPopup').classList.contains('active')) { document.getElementById('submitButton').click(); } break;
                    case '1': case '2': case '3': case '4':
                        if (document.getElementById('questionPopup').classList.contains('active') && !gameState.isSubmitting) {
                            const optionIndex = parseInt(event.key) - 1;
                            const options = document.querySelectorAll('#optionsContainer .option');
                            if (options[optionIndex]) { selectOption(optionIndex, options[optionIndex]); submitAnswer(); }
                        }
                        break;
                }
            }
        }
        function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }
        function saveStateToHistory() {
            if (historyIndex < history.length - 1) { history = history.slice(0, historyIndex + 1); }
            history.push(deepClone(gameState));
            if (history.length > MAX_HISTORY) { history.shift(); }
            historyIndex = history.length - 1;
            updateHistoryButtons();
        }
        function loadStateFromHistory(index) {
            if (index >= 0 && index < history.length) {
                gameState = deepClone(history[index]);
                historyIndex = index;
                updateAllUI();
                updateHistoryButtons();
            }
        }
        function undoStep() { if (historyIndex > 0) { loadStateFromHistory(historyIndex - 1); } }
        function redoStep() { if (historyIndex < history.length - 1) { loadStateFromHistory(historyIndex + 1); } }
        function updateHistoryButtons() {
            document.getElementById('undoButton').disabled = historyIndex <= 0;
            document.getElementById('redoButton').disabled = historyIndex >= history.length - 1;
        }
        function updateAllUI() {
            const gameIsOver = isGameOver();
            document.getElementById('endGameButton').disabled = !gameState.gameStarted || gameIsOver;
            updatePlayersDisplay();
            updateCurrentPlayerDisplay();
            updateGameBoard();
            setTimeout(drawSnakesAndLadders, 50);
            const rollButtonsDisabled = gameIsOver || !gameState.gameStarted;
            document.getElementById('rollButton').disabled = rollButtonsDisabled;
            document.getElementById('skipTurnButton').disabled = rollButtonsDisabled;
            document.getElementById('winnersSection').style.display = gameIsOver ? 'block' : 'none';
        }
        function isGameOver() {
            if (!gameState.gameStarted) return false;
            const nonWinnersCount = gameState.players.length - gameState.winners.length;
            const maxWinners = Math.min(3, gameState.players.length > 1 ? gameState.players.length - 1 : 1);
            return (gameState.winners.length >= maxWinners && maxWinners > 0) || (nonWinnersCount <= 1 && gameState.players.length > 1);
        }
        function createBoard() {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '<svg id="svgLayer" class="svg-layer"></svg>';
            let cells = [];
            for (let i = 1; i <= BOARD_SIZE; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = `cell-${i}`;
                cell.innerHTML = `<span class="cell-number">${i}</span>`;
                if (SNAKES[i]) { cell.classList.add('snake-start'); cell.innerHTML += `<div class="emoji">🐍</div>`; } 
                else if (LADDERS[i]) { cell.classList.add('ladder-start'); cell.innerHTML += `<div class="emoji">🪜</div>`; }
                cells.push(cell);
            }
            for (let row = 9; row >= 0; row--) {
                let rowCells = cells.slice(row * 10, (row + 1) * 10);
                if (row % 2 !== 0) rowCells.reverse();
                rowCells.forEach(cell => board.appendChild(cell));
            }
        }
        function getCellCenter(cellNumber) {
            const cell = document.getElementById(`cell-${cellNumber}`);
            if (!cell) return { x: 0, y: 0 };
            const board = document.getElementById('gameBoard');
            const boardRect = board.getBoundingClientRect();
            const cellRect = cell.getBoundingClientRect();
            return { x: cellRect.left - boardRect.left + cellRect.width / 2, y: cellRect.top - boardRect.top + cellRect.height / 2 };
        }
        function drawSnakesAndLadders() {
            const svg = document.getElementById('svgLayer');
            svg.innerHTML = '';
            for (const start in LADDERS) {
                const end = LADDERS[start];
                const p1 = getCellCenter(start);
                const p2 = getCellCenter(end);
                const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
                const ladderWidth = 8;
                const p1_l = { x: p1.x - ladderWidth * Math.sin(angle), y: p1.y + ladderWidth * Math.cos(angle) };
                const p1_r = { x: p1.x + ladderWidth * Math.sin(angle), y: p1.y - ladderWidth * Math.cos(angle) };
                const p2_l = { x: p2.x - ladderWidth * Math.sin(angle), y: p2.y + ladderWidth * Math.cos(angle) };
                const p2_r = { x: p2.x + ladderWidth * Math.sin(angle), y: p2.y - ladderWidth * Math.cos(angle) };
                svg.innerHTML += `<line x1="${p1_l.x}" y1="${p1_l.y}" x2="${p2_l.x}" y2="${p2_l.y}" class="ladder-side" />`;
                svg.innerHTML += `<line x1="${p1_r.x}" y1="${p1_r.y}" x2="${p2_r.x}" y2="${p2_r.y}" class="ladder-side" />`;
                const numRungs = Math.floor(Math.sqrt((p2.x - p1.x)**2 + (p2.y - p1.y)**2) / 20);
                for (let i = 1; i <= numRungs; i++) {
                    const rung_p1 = { x: p1_l.x + (p2_l.x - p1_l.x) * i / (numRungs + 1), y: p1_l.y + (p2_l.y - p1_l.y) * i / (numRungs + 1) };
                    const rung_p2 = { x: p1_r.x + (p2_r.x - p1_r.x) * i / (numRungs + 1), y: p1_r.y + (p2_r.y - p1_r.y) * i / (numRungs + 1) };
                    svg.innerHTML += `<line x1="${rung_p1.x}" y1="${rung_p1.y}" x2="${rung_p2.x}" y2="${rung_p2.y}" class="ladder-rung" />`;
                }
            }
            for (const start in SNAKES) {
                const end = SNAKES[start];
                const p1 = getCellCenter(start);
                const p2 = getCellCenter(end);
                const mid = { x: (p1.x + p2.x) / 2, y: (p1.y + p2.y) / 2 };
                const dist = Math.sqrt((p2.x - p1.x)**2 + (p2.y - p1.y)**2);
                const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
                const offset = dist / 4;
                const control = { x: mid.x + offset * Math.sin(angle), y: mid.y - offset * Math.cos(angle) };
                const pathData = `M ${p1.x} ${p1.y} Q ${control.x} ${control.y} ${p2.x} ${p2.y}`;
                svg.innerHTML += `<path d="${pathData}" class="snake-outline" />`;
                svg.innerHTML += `<path d="${pathData}" class="snake-body" />`;
            }
        }
        function setupNumberOfPlayers() {
            document.getElementById('numPlayers').addEventListener('change', (e) => createPlayerNameInputs(parseInt(e.target.value)));
            createPlayerNameInputs(4);
        }
        function createPlayerNameInputs(num) {
            const container = document.getElementById('playerNames');
            container.innerHTML = '';
            for (let i = 1; i <= num; i++) {
                container.innerHTML += `<div class="input-group"><label for="player${i}Name">👤 Player ${i} Name:</label><input type="text" id="player${i}Name" placeholder="Player ${i}" value="Player ${i}"></div>`;
            }
        }
        function setupVolumeControl() {
            document.getElementById('volumeSlider').addEventListener('input', function() {
                gameState.volume = this.value / 100;
                document.getElementById('volumeIcon').textContent = gameState.volume > 0 ? '🔊' : '🔇';
                updateSoundVolume();
            });
        }
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            const label = document.getElementById('logoLabel');
            if (file && file.type.startsWith("image/")) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgSrc = e.target.result;
                    const headerImg = document.getElementById('gameLogoImg');
                    headerImg.src = imgSrc;
                    headerImg.style.display = 'block';
                    headerImg.parentElement.querySelector('span').style.display = 'none';
                    const boardImg = document.getElementById('boardLogoImg');
                    boardImg.src = imgSrc;
                    boardImg.style.display = 'block';
                    gameState.logoUploaded = true;
                    label.textContent = `✅ ${file.name} loaded!`;
                    label.style.background = '#d4edda';
                };
                reader.readAsDataURL(file);
            }
        }
        function setupGameNameInput() {
            document.getElementById('gameNameInput').addEventListener('input', (e) => {
                document.getElementById('gameTitle').textContent = e.target.value;
            });
        }
        function handleCsvUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => parseCSV(e.target.result);
                reader.readAsText(file);
            }
        }
        function parseCSV(csv) {
            try {
                const lines = csv.split('\n').filter(line => line.trim() !== '');
                const questions = [];
                for (let i = 0; i < lines.length; i++) {
                    const parts = lines[i].split(',').map(part => part.trim().replace(/"/g, ''));
                    if (parts.length >= 7) {
                        questions.push({
                            question: parts[0],
                            options: [parts[1], parts[2], parts[3], parts[4]],
                            answer: parseInt(parts[5]) - 1,
                            level: parts[6].toLowerCase()
                        });
                    }
                }
                if (questions.length > 0) {
                    gameState.masterQuestions = questions;
                    gameState.csvUploaded = true;
                    const label = document.getElementById('csvLabel');
                    label.innerHTML = `✅ ${questions.length} questions loaded!`;
                    label.style.background = '#d4edda';
                    label.style.borderColor = '#28a745';
                } else { throw new Error("CSV file is empty or has no valid question rows."); }
            } catch (error) {
                alert(`Error parsing CSV: ${error.message}`);
                const label = document.getElementById('csvLabel');
                label.innerHTML = `❌ Error loading file. Try again.`;
                label.style.background = '#f8d7da';
                label.style.borderColor = '#d9534f';
            }
        }
        function updatePlayersDisplay() {
            const list = document.getElementById('playersList');
            list.innerHTML = gameState.players.map(p => {
                const colors = { 'player-1':'#e74c3c', 'player-2':'#3498db', 'player-3':'#2ecc71', 'player-4':'#f1c40f', 'player-5':'#9b59b6', 'player-6':'#1abc9c'};
                const positionText = gameState.winners.find(w => w.name === p.name) ? 'Finished' : (p.position || 'Start');
                return `<div class="player-item"><span style="display:inline-block;width:20px;height:20px;border-radius:50%;background-color:${colors[p.color]};margin-right:10px;"></span><span>${p.name}</span><span>Pos: ${positionText}</span></div>`;
            }).join('');
        }
        function updateCurrentPlayerDisplay() {
            if (gameState.players.length === 0 || isGameOver()) return;
            const player = gameState.players[gameState.currentPlayerIndex];
            const display = document.getElementById('currentPlayerDisplay');
            display.textContent = `${player.name}'s Turn`;
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#1abc9c'];
            display.style.background = `linear-gradient(135deg, ${colors[gameState.currentPlayerIndex % colors.length]}, ${colors[(gameState.currentPlayerIndex + 1) % colors.length]})`;
        }
        function updateGameBoard() {
            document.querySelectorAll('.player').forEach(p => p.remove());
            gameState.players.forEach((player, index) => {
                if (player.position > 0 && !gameState.winners.find(w => w.name === player.name)) {
                    const cell = document.getElementById(`cell-${player.position}`);
                    if (cell) {
                        const playerEl = document.createElement('div');
                        playerEl.className = `player ${player.color}`;
                        playerEl.textContent = index + 1;
                        const existingPlayers = cell.querySelectorAll('.player').length;
                        playerEl.style.transform = `translate(${existingPlayers * 5}px, -${existingPlayers * 5}px)`;
                        cell.appendChild(playerEl);
                    }
                }
            });
        }
        function skipTurn() {
            if (isGameOver() || document.getElementById('rollButton').disabled) return;
            nextPlayer();
            updateAllUI();
            saveStateToHistory();
        }
        function rollDice() {
            if (!gameState.gameStarted || document.getElementById('rollButton').disabled) return;
            const dicePopup = document.getElementById('dicePopup');
            const dicePopupContent = document.getElementById('dicePopupContent');
            const sideBarDice = document.getElementById('dice');
            const rollButton = document.getElementById('rollButton');
            const skipTurnButton = document.getElementById('skipTurnButton');
            rollButton.disabled = true;
            skipTurnButton.disabled = true;
            dicePopup.classList.add('active');
            dicePopupContent.classList.add('rolling');
            playSound('diceRollSound');
            const player = gameState.players[gameState.currentPlayerIndex];
            let forcedRoll = 0;
            if (player.stuckCounter >= MAX_STUCK_TURNS && player.position > (BOARD_SIZE - 6)) {
                forcedRoll = BOARD_SIZE - player.position;
            }
            let rollCount = 0;
            const rollInterval = setInterval(() => {
                const randomFace = ['⚀', '⚁', '⚂', '⚃', '⚄', '⚅'][Math.floor(Math.random() * 6)];
                dicePopupContent.textContent = randomFace;
                sideBarDice.textContent = randomFace;
                if (++rollCount > 10) {
                    clearInterval(rollInterval);
                    const finalRoll = (forcedRoll > 0) ? forcedRoll : Math.floor(Math.random() * 6) + 1;
                    const finalFace = ['⚀', '⚁', '⚂', '⚃', '⚄', '⚅'][finalRoll - 1];
                    dicePopupContent.textContent = finalFace;
                    sideBarDice.textContent = finalFace;
                    dicePopupContent.classList.remove('rolling');
                    setTimeout(() => {
                        dicePopup.classList.remove('active');
                        setTimeout(() => showQuestion(finalRoll), 300);
                    }, 1000);
                }
            }, 100);
        }
        function showQuestion(diceRoll) {
            if (gameState.availableQuestions.length === 0) {
                gameState.availableQuestions = [...gameState.usedQuestions];
                gameState.usedQuestions = [];
            }
            const level = diceRoll <= 2 ? 'easy' : (diceRoll <= 4 ? 'medium' : 'hard');
            let pool = gameState.availableQuestions.filter(q => q.level === level);
            if (pool.length === 0) pool = gameState.availableQuestions;
            if (pool.length === 0) { alert('FATAL ERROR: No questions available.'); return; }
            const questionIndexInPool = Math.floor(Math.random() * pool.length);
            const question = pool[questionIndexInPool];
            gameState.currentQuestion = question;
            gameState.selectedOption = -1;
            document.getElementById('questionPopup').dataset.diceRoll = diceRoll;
            document.getElementById('questionText').textContent = gameState.currentQuestion.question;
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            gameState.currentQuestion.options.forEach((opt, i) => {
                const optEl = document.createElement('div');
                optEl.className = 'option';
                optEl.textContent = `${i + 1}. ${opt}`;
                optEl.onclick = () => selectOption(i, optEl);
                optionsContainer.appendChild(optEl);
            });
            document.getElementById('questionPopup').classList.add('active');
            startQuestionTimer();
        }
        function startQuestionTimer() {
            let timeLeft = gameState.timerDuration;
            const timerEl = document.getElementById('questionTimer');
            timerEl.classList.remove('warning');
            clearInterval(gameState.questionTimer);
            gameState.questionTimer = setInterval(() => {
                timerEl.textContent = timeLeft;
                playSound('timerTickSound');
                if (timeLeft <= 5 && !timerEl.classList.contains('warning')) timerEl.classList.add('warning');
                if (--timeLeft < 0) {
                    clearInterval(gameState.questionTimer);
                    submitAnswer();
                }
            }, 1000);
        }
        function selectOption(index, el) {
            if (gameState.isSubmitting) return;
            document.querySelectorAll('.option.selected').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            gameState.selectedOption = index;
        }
        function submitAnswer() {
            if (gameState.isSubmitting) return;
            gameState.isSubmitting = true;
            const timerTickAudio = document.getElementById('timerTickSound');
            if (timerTickAudio) { timerTickAudio.pause(); timerTickAudio.currentTime = 0; }
            clearInterval(gameState.questionTimer);
            const isCorrect = gameState.selectedOption === gameState.currentQuestion.answer;
            const diceRoll = parseInt(document.getElementById('questionPopup').dataset.diceRoll, 10);
            const questionIndex = gameState.availableQuestions.findIndex(q => q.question === gameState.currentQuestion.question);
            if (questionIndex > -1) {
                const [usedQuestion] = gameState.availableQuestions.splice(questionIndex, 1);
                gameState.usedQuestions.push(usedQuestion);
            }
            document.querySelectorAll('.option').forEach((opt, i) => {
                if (i === gameState.currentQuestion.answer) opt.classList.add('correct');
                else if (i === gameState.selectedOption) opt.classList.add('wrong');
            });
            setTimeout(() => {
                document.getElementById('questionPopup').classList.remove('active');
                if (isCorrect) playSound('correctSound'); else playSound('wrongSound');
                handleMove(diceRoll, isCorrect);
                gameState.isSubmitting = false;
            }, 2000);
        }
        function finishTurn() {
            updateAllUI();
            if (isGameOver()) { endGame(); } 
            else {
                nextPlayer();
                if (!isGameOver()) {
                    document.getElementById('rollButton').disabled = false;
                    document.getElementById('skipTurnButton').disabled = false;
                }
                saveStateToHistory();
            }
        }
        function handleMove(steps, isCorrect) {
            const player = gameState.players[gameState.currentPlayerIndex];
            const oldPosition = player.position;
            if (isCorrect) {
                const newPosition = oldPosition + steps;
                if (newPosition > BOARD_SIZE) { player.stuckCounter++; finishTurn(); return; }
                player.position = newPosition;
                player.stuckCounter = 0;
                updateGameBoard();
                playSound('moveSound');
                setTimeout(() => {
                    if (LADDERS[player.position]) { player.position = LADDERS[player.position]; playSound('ladderSound'); }
                    if (player.position === 100 && !gameState.winners.some(w => w.name === player.name)) { gameState.winners.push(player); playSound('winSound'); }
                    finishTurn();
                }, 600);
            } else {
                const potentialPosition = oldPosition + steps;
                if (SNAKES[potentialPosition] && potentialPosition <= BOARD_SIZE) {
                    player.position = potentialPosition;
                    updateGameBoard();
                    playSound('moveSound');
                    setTimeout(() => { player.position = SNAKES[potentialPosition]; playSound('snakeSound'); finishTurn(); }, 600);
                } else { finishTurn(); }
            }
        }
        function nextPlayer() {
            do { gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length; } 
            while (gameState.winners.some(p => p.name === gameState.players[gameState.currentPlayerIndex].name) && !isGameOver());
            updateCurrentPlayerDisplay();
        }
        function endGame() {
            const list = document.getElementById('winnersList');
            const remainingPlayers = gameState.players.filter(p => !gameState.winners.some(w => w.name === p.name)).sort((a, b) => b.position - a.position);
            const finalRanking = [...gameState.winners, ...remainingPlayers];
            list.innerHTML = finalRanking.map((p, i) => {
                const rankText = ['🥇', '🥈', '🥉'][i] || `${i + 1}.`;
                return `<div class="winner-item"><span>${rankText} ${p.name}</span></div>`;
            }).join('');
            document.getElementById('winnersSection').style.display = 'block';
            document.getElementById('rollButton').disabled = true;
            document.getElementById('skipTurnButton').disabled = true;
            document.getElementById('endGameButton').disabled = true;
            document.getElementById('currentPlayerDisplay').textContent = "Game Over!";
            saveStateToHistory();
        }
        function forceEndGame() {
            if (!gameState.gameStarted || isGameOver()) return;
            if (confirm('Are you sure you want to end the game and declare winners now?')) { endGame(); }
        }
        function resetGame() {
            initializeGameState();
            gameState.masterQuestions = [...DEFAULT_QUESTIONS];
            const headerImg = document.getElementById('gameLogoImg');
            headerImg.src = ''; headerImg.style.display = 'none';
            headerImg.parentElement.querySelector('span').style.display = 'inline';
            const boardImg = document.getElementById('boardLogoImg');
            boardImg.src = ''; boardImg.style.display = 'none';
            document.getElementById('logoUpload').value = "";
            document.getElementById('logoLabel').innerHTML = `📁 Click to upload Logo`;
            document.getElementById('logoLabel').style.background = '#ecf0f1';
            document.getElementById('gameSection').classList.remove('active');
            document.getElementById('setupSection').classList.add('active');
            document.getElementById('winnersSection').style.display = 'none';
            document.getElementById('dice').textContent = '🎲';
            document.getElementById('rollButton').disabled = false;
            document.getElementById('skipTurnButton').disabled = false;
            document.getElementById('endGameButton').disabled = true;
            document.getElementById('svgLayer').innerHTML = '';
            const csvLabel = document.getElementById('csvLabel');
            csvLabel.innerHTML = `📁 Click to upload CSV<br><small>Format: q,o1,o2,o3,o4,ans,lvl</small>`;
            csvLabel.style.background = '#ecf0f1';
            csvLabel.style.borderColor = '#bdc3c7';
            document.getElementById('csvUpload').value = "";
            document.querySelectorAll('.sound-upload-label').forEach(label => {
                label.textContent = 'Select file...';
                label.style.backgroundColor = '#ecf0f1';
            });
            document.querySelectorAll('.sound-effects audio').forEach(audio => { audio.src = ''; });
            history = [];
            historyIndex = -1;
            updateHistoryButtons();
            createBoard();
        }
        function updateSoundVolume() { document.querySelectorAll('audio').forEach(audio => audio.volume = gameState.volume); }
        function toggleFullscreen() {
            const el = document.getElementById('gameContainer');
            if (!document.fullscreenElement) el.requestFullscreen().catch(err => console.error(err));
            else document.exitFullscreen();
        }
        document.addEventListener('fullscreenchange', () => {
            const btn = document.getElementById('fullscreenBtn');
            btn.textContent = document.fullscreenElement ? '⛶ Exit Fullscreen' : '⛶ Fullscreen';
        });

    </script>
</body>
</html>
